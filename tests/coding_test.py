# Copyright © 2024 Karol Będkowski <Karol Będkowski@kkomp>
#
# Distributed under terms of the GPLv3 license.
# pylint: disable=protected-access,unspecified-encoding,consider-using-with
# mypy: allow-untyped-defs, allow-untyped-calls
# ruff: noqa: SLF001,PLR2004

""" """

from contextlib import suppress

import pytest

with suppress(ImportError):
    import icecream

    icecream.install()

from icom_icr6 import coding


@pytest.mark.parametrize(
    ("freq", "offset", "exp_flags", "exp_freq", "exp_offset"),
    [
        (100000, 0, 0b0000, 20, 0),
        (100000, 100000, 0b0000, 20, 20),
        (100000, 1000000, 0b0000, 20, 200),
        (100000, 1230000, 0b0000, 20, 246),
        (100000, 1231250, 0b0101, 16, 197),
        (100000, 1235000, 0b0000, 20, 247),
        (100000, 625000, 0b0000, 20, 125),
        (100000, 831250, 0b0101, 16, 133),
        (100000, 90000, 0b0000, 20, 18),
        (250000, 0, 0b0000, 50, 0),
        (400000, 0, 0b0000, 80, 0),
        (400000, 5000000, 0b0000, 80, 1000),
        (500000, 0, 0b0000, 100, 0),
        (500000, 7000000, 0b0000, 100, 1400),
        (625000, 0, 0b0000, 125, 0),
        (625000, 7600000, 0b0000, 125, 1520),
        (631250, 0, 0b0101, 101, 0),
        (631250, 159995000, 0b0001, 101, 31999),
        (831250, 0, 0b0101, 133, 0),
        (831250, 100000, 0b0101, 133, 16),
        (831250, 1235000, 0b0001, 133, 247),
        (831250, 1312500, 0b0101, 133, 210),
        (831250, 625000, 0b0101, 133, 100),
        (831250, 831250, 0b0101, 133, 133),
        (831250, 90000, 0b1101, 133, 10),
        (891000, 0, 0b1111, 99, 0),
        (891000, 1_000_000, 0b0011, 99, 200),
        (891000, 9_000_000, 0b1111, 99, 1000),
        (900000, 0, 0b1111, 100, 0),
        (900000, 1000000, 0b0000, 180, 200),
        (912500, 0, 0b0101, 146, 0),
        (1000000, 0, 0b0000, 200, 0),
        (1000000, 10000000, 0b0000, 200, 2000),
        (1071000, 123000000, 0b0011, 119, 24600),
        (1071000, 159995000, 0b0011, 119, 31999),
        (1179000, 0, 0b1111, 131, 0),
        (1179000, 100000, 0b0011, 131, 20),
        (1179000, 1230000, 0b0011, 131, 246),
        (1179000, 1235000, 0b0011, 131, 247),
        (1179000, 625000, 0b0011, 131, 125),
        (1179000, 831250, 0b0111, 131, 133),
        (3310000, 0, 0b0000, 662, 0),
        (3755000, 0, 0b0000, 751, 0),
        (4625000, 0, 0b0000, 925, 0),
        (4770000, 0, 0b1111, 530, 0),
        (4930000, 0, 0b0000, 986, 0),
        (5005000, 0, 0b0000, 1001, 0),
        (5060000, 0, 0b0000, 1012, 0),
        (5450000, 0, 0b0000, 1090, 0),
        (6055000, 0, 0b0000, 1211, 0),
        (6080000, 0, 0b0000, 1216, 0),
        (6090000, 0, 0b0000, 1218, 0),
        (6110000, 0, 0b0000, 1222, 0),
        (6150000, 0, 0b0000, 1230, 0),
        (6165000, 0, 0b1111, 685, 0),
        (6175000, 0, 0b0000, 1235, 0),
        (6250000, 12000000, 0b0000, 1250, 2400),
        (7125000, 0, 0b0000, 1425, 0),
        (7230000, 0, 0b0000, 1446, 0),
        (7290000, 0, 0b1111, 810, 0),
        (7305000, 0, 0b0000, 1461, 0),
        (7325000, 0, 0b0000, 1465, 0),
        (9640000, 0, 0b0000, 1928, 0),
        (9650000, 0, 0b0000, 1930, 0),
        (9705000, 0, 0b0000, 1941, 0),
        (9875000, 0, 0b0000, 1975, 0),
        (9885000, 0, 0b0000, 1977, 0),
        (9925000, 0, 0b0000, 1985, 0),
        (10000000, 0, 0b0000, 2000, 0),
        (11620000, 0, 0b0000, 2324, 0),
        (11655000, 0, 0b1111, 1295, 0),
        (11675000, 0, 0b0000, 2335, 0),
        (11690000, 0, 0b0000, 2338, 0),
        (11700000, 0, 0b1111, 1300, 0),
        (11710000, 0, 0b0000, 2342, 0),
        (11715000, 0, 0b0000, 2343, 0),
        (11910000, 0, 0b0000, 2382, 0),
        (11940000, 0, 0b0000, 2388, 0),
        (11985000, 0, 0b0000, 2397, 0),
        (11990000, 0, 0b0000, 2398, 0),
        (12015000, 0, 0b1111, 1335, 0),
        (12040000, 0, 0b0000, 2408, 0),
        (12095000, 0, 0b0000, 2419, 0),
        (13660000, 0, 0b0000, 2732, 0),
        (13675000, 0, 0b0000, 2735, 0),
        (13680000, 0, 0b1111, 1520, 0),
        (13695000, 0, 0b0000, 2739, 0),
        (13720000, 0, 0b0000, 2744, 0),
        (14070000, 0, 0b0000, 2814, 0),
        (15060000, 0, 0b0000, 3012, 0),
        (15060000, 159995000, 0b0000, 3012, 31999),
        (15105000, 0, 0b0000, 3021, 0),
        (15120000, 0, 0b1111, 1680, 0),
        (15325000, 0, 0b0000, 3065, 0),
        (15340000, 0, 0b0000, 3068, 0),
        (15580000, 0, 0b0000, 3116, 0),
        (15600000, 0, 0b0000, 3120, 0),
        (15615000, 0, 0b1111, 1735, 0),
        (15660000, 0, 0b1111, 1740, 0),
        (17580000, 0, 0b0000, 3516, 0),
        (17670000, 0, 0b0000, 3534, 0),
        (17870000, 0, 0b0000, 3574, 0),
        (18000000, 0, 0b1111, 2000, 0),
        (18160000, 0, 0b0000, 3632, 0),
        (18960000, 0, 0b0000, 3792, 0),
        (20000000, 2000000, 0b0000, 4000, 400),
        (21590000, 0, 0b0000, 4318, 0),
        (21605000, 0, 0b0000, 4321, 0),
        (21815000, 0, 0b0000, 4363, 0),
        (24990000, 500000, 0b0000, 4998, 100),
        (25000000, 0, 0b0000, 5000, 0),
        (25000000, 3000000, 0b0000, 5000, 600),
        (26960000, 0, 0b0000, 5392, 0),
        (26970000, 0, 0b0000, 5394, 0),
        (26980000, 0, 0b0000, 5396, 0),
        (27000000, 0, 0b1111, 3000, 0),
        (27010000, 0, 0b0000, 5402, 0),
        (27020000, 0, 0b0000, 5404, 0),
        (27120000, 0, 0b0000, 5424, 0),
        (27170000, 0, 0b0000, 5434, 0),
        (27180000, 0, 0b1111, 3020, 0),
        (27200000, 0, 0b0000, 5440, 0),
        (27210000, 0, 0b0000, 5442, 0),
        (27250000, 0, 0b0000, 5450, 0),
        (27260000, 0, 0b0000, 5452, 0),
        (27270000, 0, 0b1111, 3030, 0),
        (27280000, 0, 0b0000, 5456, 0),
        (27340000, 0, 0b0000, 5468, 0),
        (27350000, 0, 0b0000, 5470, 0),
        (27360000, 0, 0b1111, 3040, 0),
        (27370000, 0, 0b0000, 5474, 0),
        (27400000, 0, 0b0000, 5480, 0),
        (45000000, 0, 0b1111, 5000, 0),
        (45000000, 4000000, 0b0000, 9000, 800),
        (45000000, 500000, 0b0000, 9000, 100),
        (62500000, 500000, 0b0000, 12500, 100),
        (63331250, 159995000, 0b0001, 10133, 31999),
        (63331250, 500000, 0b0101, 10133, 80),
        (90000000, 0, 0b1111, 10000, 0),
        (90000000, 5000000, 0b0000, 18000, 1000),
        (100000000, 0, 0b0000, 20000, 0),
        (120000000, 0, 0b0000, 24000, 0),
        (120000000, 1000000, 0b0000, 24000, 200),
        (120225000, 0, 0b0000, 24045, 0),
        (120230000, 0, 0b0000, 24046, 0),
        (123000000, 0, 0b0000, 24600, 0),
        (123000000, 10000, 0b0000, 24600, 2),
        (123625000, 0, 0b0000, 24725, 0),
        (124991666, 1233333, 0b1010, 14999, 148),
        (124991666, 1330000, 0b0010, 14999, 266),
        (125000000, 0, 0b0000, 25000, 0),
        (125005000, 0, 0b0000, 25001, 0),
        (134875000, 0, 0b0000, 26975, 0),
        (137100000, 600000, 0b0000, 27420, 120),
        (138475000, 600000, 0b0000, 27695, 120),
        (136991666, 0, 0b1010, 16439, 0),
        (141225000, 600000, 0b0000, 28245, 120),
        (143625000, 600000, 0b0000, 28725, 120),
        (145500000, 0, 0b0000, 29100, 0),
        (145800000, 600000, 0b0000, 29160, 120),
        (145875000, 600000, 0b0000, 29175, 120),
        (145956250, 600000, 0b0101, 23353, 96),
        (145985000, 600000, 0b0000, 29197, 120),
        (147825000, 600000, 0b0000, 29565, 120),
        (147837500, 600000, 0b0101, 23654, 96),
        (147887500, 600000, 0b0101, 23662, 96),
        (147912500, 600000, 0b0101, 23666, 96),
        (148125000, 600000, 0b0000, 29625, 120),
        (148150000, 600000, 0b0000, 29630, 120),
        (148525000, 600000, 0b0000, 29705, 120),
        (148550000, 600000, 0b0000, 29710, 120),
        (148562500, 600000, 0b0101, 23770, 96),
        (148575000, 600000, 0b0000, 29715, 120),
        (148587500, 600000, 0b0101, 23774, 96),
        (148687500, 600000, 0b0101, 23790, 96),
        (148700000, 600000, 0b0000, 29740, 120),
        (148775000, 600000, 0b0000, 29755, 120),
        (148875000, 600000, 0b0000, 29775, 120),
        (149087500, 600000, 0b0101, 23854, 96),
        (149137500, 600000, 0b0101, 23862, 96),
        (149162500, 600000, 0b0101, 23866, 96),
        (149175000, 600000, 0b0000, 29835, 120),
        (149212500, 600000, 0b0101, 23874, 96),
        (149225000, 600000, 0b0000, 29845, 120),
        (149237500, 600000, 0b0101, 23878, 96),
        (149250000, 600000, 0b0000, 29850, 120),
        (149262500, 600000, 0b0101, 23882, 96),
        (149275000, 600000, 0b0000, 29855, 120),
        (149312500, 600000, 0b0101, 23890, 96),
        (151025000, 600000, 0b0000, 30205, 120),
        (151250000, 600000, 0b0000, 30250, 120),
        (151600000, 600000, 0b0000, 30320, 120),
        (151650000, 600000, 0b0000, 30330, 120),
        (151825000, 600000, 0b0000, 30365, 120),
        (152887500, 600000, 0b0101, 24462, 96),
        (153350000, 600000, 0b0000, 30670, 120),
        (153775000, 600000, 0b0000, 30755, 120),
        (154550000, 600000, 0b0000, 30910, 120),
        (154850000, 600000, 0b0000, 30970, 120),
        (159962500, 600000, 0b0101, 25594, 96),
        (160525000, 600000, 0b0000, 32105, 120),
        (160537500, 600000, 0b0101, 25686, 96),
        (163612500, 600000, 0b0101, 26178, 96),
        (168500000, 600000, 0b0000, 33700, 120),
        (168562500, 600000, 0b0101, 26970, 96),
        (168587500, 600000, 0b0101, 26974, 96),
        (168625000, 600000, 0b0000, 33725, 120),
        (168675000, 600000, 0b0000, 33735, 120),
        (168787500, 600000, 0b0101, 27006, 96),
        (168800000, 600000, 0b0000, 33760, 120),
        (168812500, 600000, 0b0101, 27010, 96),
        (168825000, 600000, 0b0000, 33765, 120),
        (168887500, 600000, 0b0101, 27022, 96),
        (168925000, 600000, 0b0000, 33785, 120),
        (168937500, 600000, 0b0101, 27030, 96),
        (168962500, 600000, 0b0101, 27034, 96),
        (169000000, 600000, 0b0000, 33800, 120),
        (169025000, 600000, 0b0000, 33805, 120),
        (171112500, 0, 0b0101, 27378, 0),
        (172350000, 600000, 0b0000, 34470, 120),
        (172450000, 600000, 0b0000, 34490, 120),
        (173400000, 600000, 0b0000, 34680, 120),
        (173575000, 600000, 0b0000, 34715, 120),
        (200000000, 2000000, 0b0000, 40000, 400),
        (220000000, 2000000, 0b0000, 44000, 400),
        (220000000, 600000, 0b0000, 44000, 120),
        (255520000, 0, 0b0000, 51104, 0),
        (326100000, 0, 0b0000, 65220, 0),
        (350000000, 0, 0b0000, 70000, 0),
        (375000000, 0, 0b0000, 75000, 0),
        (379000000, 0, 0b0000, 75800, 0),
        (435050000, 600000, 0b0000, 87010, 120),
        (435075000, 7600000, 0b0000, 87015, 1520),
        (436510000, 600000, 0b0000, 87302, 120),
        (436510000, 7600000, 0b0000, 87302, 1520),
        (437800000, 7600000, 0b0000, 87560, 1520),
        (438950000, 7600000, 0b0000, 87790, 1520),
        (439225000, 7600000, 0b0000, 87845, 1520),
        (443500000, 7600000, 0b0000, 88700, 1520),
        (446006250, 600000, 0b0101, 71361, 96),
        (446018750, 0, 0b0101, 71363, 0),
        (446018750, 7600000, 0b0101, 71363, 1216),
        (446031250, 7600000, 0b0101, 71365, 1216),
        (446043750, 7600000, 0b0101, 71367, 1216),
        (446056250, 7600000, 0b0101, 71369, 1216),
        (446068750, 7600000, 0b0101, 71371, 1216),
        (446093750, 600000, 0b0101, 71375, 96),
        (446106250, 600000, 0b0101, 71377, 96),
        (446118750, 7600000, 0b0101, 71379, 1216),
        (446131250, 7600000, 0b0101, 71381, 1216),
        (446143750, 7600000, 0b0101, 71383, 1216),
        (446156250, 7600000, 0b0101, 71385, 1216),
        (446168750, 0, 0b0101, 71387, 0),
        (446181250, 7600000, 0b0101, 71389, 1216),
        (446193750, 600000, 0b0101, 71391, 96),
        (466031250, 7600000, 0b0101, 74565, 1216),
        (500000000, 1000000, 0b0000, 100000, 200),
        (824000000, 0, 0b0000, 164800, 0),
        (833330000, 10000000, 0b0000, 166666, 2000),
        (833330000, 12000000, 0b0000, 166666, 2400),
        (1000000000, 0, 0b0000, 200000, 0),
        (1000000000, 3000000, 0b0000, 200000, 600),
        (1309995000, 0, 0b1111, 145555, 0),
        (1309995000, 159995000, 0b0000, 261999, 31999),
        (1309995000, 500000, 0b0000, 261999, 100),
    ],
)
def test_encode_freq(freq, offset, exp_freq, exp_flags, exp_offset):
    res = coding.encode_freq(freq, offset)
    assert res.freq == exp_freq
    assert res.flags == exp_flags
    assert res.offset == exp_offset


@pytest.mark.parametrize(
    ("inp", "encoded"),
    [
        ("TE", b"\x0d\x25\x00\x00\x00"),
        ("FSDFS", b"\x09\xb3\x92\x6c\xc0"),
        ("UZBEKI", b"\x0d\x7a\x8a\x5a\xe9"),
        ("NETH-3", b"\x0b\xa5\xd2\x83\x53"),
        ("CAN/GE", b"\x08\xe1\xb8\xf9\xe5"),
    ],
)
def test_encode_decode_name(inp, encoded):
    enc = coding.encode_name(inp)
    assert enc == list(encoded)

    dec = coding.decode_name(encoded)
    assert dec == inp


@pytest.mark.parametrize(
    ("region", "flags", "exp"),
    [
        (0, 1, 0x03),
        (1, 1, 0x1A),
        (1, 2, 0b00000000_00011100),
        (1, 3, 0b00000000_00011111),
        (2, 1, 0x2A),
        (6, 1, 0xAB),
        (13, 1, 0x01D2),
        (13, 2, 0b00000001_11010100),
        (13, 3, 0b00000001_11010111),
    ],
)
def test_etcdata_from_region(region, flags, exp):
    etcdata = coding.region_to_etcdata(region, flags)
    assert etcdata == exp
    assert coding.etcdata_to_region(etcdata) == (region, flags)
